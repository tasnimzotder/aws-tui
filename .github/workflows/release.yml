name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    name: GoReleaser
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test ./...

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  homebrew:
    name: Update Homebrew
    runs-on: ubuntu-latest
    needs: release
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Homebrew Tap
        env:
          TAP_TOKEN: ${{ secrets.TAP_TOKEN }}
          TAG_VERSION: ${{ github.ref_name }}
        run: |
          VERSION_NUM="${TAG_VERSION#v}"

          # Download checksums from the release
          curl -sL "https://github.com/tasnimzotder/aws-tui/releases/download/${TAG_VERSION}/checksums.txt" -o checksums.txt

          SHA_DARWIN_AMD64=$(grep "darwin_amd64" checksums.txt | awk '{print $1}')
          SHA_DARWIN_ARM64=$(grep "darwin_arm64" checksums.txt | awk '{print $1}')
          SHA_LINUX_AMD64=$(grep "linux_amd64" checksums.txt | awk '{print $1}')
          SHA_LINUX_ARM64=$(grep "linux_arm64" checksums.txt | awk '{print $1}')

          git clone "https://x-access-token:${TAP_TOKEN}@github.com/tasnimzotder/homebrew-tap.git"
          cd homebrew-tap

          mkdir -p Formula
          sed -e "s/{{VERSION_NUM}}/${VERSION_NUM}/g" \
              -e "s/{{VERSION}}/${TAG_VERSION}/g" \
              -e "s/{{SHA_DARWIN_AMD64}}/${SHA_DARWIN_AMD64}/g" \
              -e "s/{{SHA_DARWIN_ARM64}}/${SHA_DARWIN_ARM64}/g" \
              -e "s/{{SHA_LINUX_AMD64}}/${SHA_LINUX_AMD64}/g" \
              -e "s/{{SHA_LINUX_ARM64}}/${SHA_LINUX_ARM64}/g" \
              ../.github/homebrew/aws-tui.rb.template > Formula/aws-tui.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/aws-tui.rb
          git commit -m "Update aws-tui to ${TAG_VERSION}" || exit 0
          git push
